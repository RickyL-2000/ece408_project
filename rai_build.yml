rai:
  version: 0.2
  image: jnativ/ece408_minidnn_docker_sp21:latest
resources:
  cpu:
    architecture: amd64
  gpu:
    architecture: volta
    count: 1
  network: false
commands:
  build:
      # Do not modify the following commands
      - /bin/bash -c "mkdir /build/student_code && cp -rv /src/* /build/student_code" # copy the project folder to /build so everything appears in the upload
      - /bin/bash -c "cp /ece408/project/build/weights-86.bin /build" # Copy pretrained weights
      - /bin/bash -c "cp -rv /src/custom/* /ece408/project/src/layer/custom" # copy custom layers to mini-dnn file tree
      - /bin/bash -c "cmake -DCMAKE_CXX_FLAGS=-pg /ece408/project/ && make -j8"

      ### You may modify the commands below. Uncomment/Comment lines based on the milestone

      # troubleshootings:
        # https://campuswire.com/c/GCBA2369E/feed/467

      # run "./rai -p <project-folder> --queue rai_amd64_ece408" to execute ("./rai -p ece408_project --queue rai_amd64_ece408")
      # run "./rai -p <project-folder> --queue rai_amd64_ece408" to execute ("./rai -p ece408_project --queue rai_amd64_exclusive") exclusively
      # run "./rai -p <project folder> --queue rai_amd64_ece408 --submit=m1" to submit ("./rai -p ece408_project --queue rai_amd64_ece408 --submit=m1")
      # run "./rai -p <project-folder> history" to check submission. which should list an "m1" in the "SUBMITTED" column for that submission ("./rai -p ece408_project history")

      # ---------------- milestone 1 ----------------- #
      # - /bin/bash -c "time ./m1 100"  # 100 is the batchsize and default is 10000 (the max size) # "time" flag can time the whole program execution
      # - /bin/bash -c "time ./m1 1000"

      # use "gprof" to profile the execution
      # - /bin/bash -c "gprof -Q m1 gmon.out"

      # ---------------- milestone 2 ----------------- #
      # - /bin/bash -c "time ./m2 10000"
      
      # check ememory errorsa
      # - /bin/bash -c "cuda-memcheck ./m2 100"

      # use nsys to profile the execution
      # - nsys profile --stats=true ./m2

      # use nsight
      # - nv-nsight-cu-cli --section '.*' -o analysis_file ./m2

      # ---------------- milestone 3 ----------------- #
      # use the "--queue rai_amd64_exclusive" flag to run your code on the exclusive server
      - /bin/bash -c "time ./m3 1000"

      # - nsys profile --stats=true ./m3

      # - nv-nsight-cu-cli --section '.*' -o analysis_file ./m3

